
const SHEET_STORES = 'Stores';
const SHEET_USERS = 'Users';
const SHEET_UNITS = 'Units';
const SHEET_ROLES = 'Roles';
const SHEET_LOGS = 'AccessLogs';
const SHEET_DAILY = 'DailyStats';
const SHEET_STORE_HISTORY = 'StoreHistory';
const SHEET_FILE_INDEX = 'FileIndex';
const SHEET_PL_SKU = 'PL SKU';
const SHEET_PRICES = 'PriceMap';
const SHEET_FINANCE_META = 'FinanceMeta';
const SHEET_NEWS = 'News';
const SHEET_NEWS_COMMENTS = 'NewsComments';
const SHEET_NEWS_LIKES = 'NewsLikes';

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(30000); 
  try {
    const postData = JSON.parse(e.postData.contents);
    const action = postData.action;
    let result = {};

    // --- NEWS ACTIONS ---
    if (action === 'getNews') result = handleGetNews(postData.username);
    else if (action === 'addNews') result = handleAddNews(postData);
    else if (action === 'addComment') result = handleAddComment(postData);
    else if (action === 'toggleLike') result = handleToggleLike(postData.newsId, postData.username);

    // --- OTHER ACTIONS ---
    else if (action === 'getOrders') result = getOrdersFromMonthFile(postData.month);
    else if (action === 'getUsers') result = getUsers();
    else if (action === 'login') result = handleLogin(postData.username, postData.password, postData.ip);
    else if (action === 'createUser') result = createUser(postData.username, postData.password, postData.fullName, postData.role, postData.email, postData.phone, postData.permissions);
    else if (action === 'updateUser') result = updateUser(postData.username, postData.role, postData.status, postData.permissions);
    else if (action === 'getStores') result = getData(SHEET_STORES);
    else if (action === 'addStore') result = addRow(SHEET_STORES, [postData.id, postData.name, postData.url, postData.region||"", postData.status||"LIVE", 0, 0]);
    else if (action === 'getFinance') result = getFinance(postData.year);
    else if (action === 'addFinance') result = addFinance(postData.year, postData.transaction);

    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: err.toString() })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
    // Trả về JSON cho GET requests nếu cần
    return ContentService.createTextOutput(JSON.stringify({status: "alive"})).setMimeType(ContentService.MimeType.JSON);
}
